<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="img/logo pkp.png" type="image/png">
    <title>PKP PKNS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <!-- Navbar -->
    <div id="header"></div>

    <!-- Hero Section -->
    <header class="bg-light text-center py-3" style="margin-top: 80px;">
        <div class="section-header">
            <div class="section-line"></div>
            <h2 class="section-title">Borang</h2>
            <div class="section-line-right"></div>
        </div>
    </header>

    <!-- PDF Section -->
    <section class="container my-5">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="p-3 shadow-sm rounded bg-white list-item"
                    onclick="openPdf('documents/laporan tahunan 2015-2017.pdf')">
                    Laporan Tahunan 2015 - 2017
                </div>
            </div>
        </div>
    </section>

    <!-- PDF Viewer Overlay -->
    <div id="pdfOverlay" class="pdf-overlay">
        <div class="pdf-popup">

            <div class="pdf-header">
                <span class="pdf-title" id="pdfTitle">Loading PDF...</span>
                <div class="pdf-controls">
                    <button class="pdf-btn" onclick="zoomOut()" title="Zoom Out">
                        <span>−</span>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="pdf-btn" onclick="zoomIn()" title="Zoom In">
                        <span>+</span>
                    </button>
                    <span class="page-info" id="pageInfo">0 / 0</span>
                    <button class="pdf-btn" onclick="printPdf()" title="Print">
                        <span><i style="font-size: 16px;" class="fa fa-print"></i></span>
                    </button>

                    <button class="pdf-btn" onclick="downloadPdf()" title="Download">
                        <span><i style="font-size: 16px;" class="fas fa-download"></i></span>
                    </button>

                    <button style="background-color: #d62839; padding: 6px 12px; font-weight: bold;" class="pdf-btn"
                        onclick="closePdf()" title="Close">X</button>
                </div>
            </div>

            <div class="pdf-header" style="display: none;">
                <span class="pdf-title" id="pdfTitle2">Loading PDF...</span>
                <div class="pdf-controls">
                </div>
            </div>
            <div class="pdf-content" id="pdfContentArea">
                <div class="pdf-loading">Loading PDF...</div>
                <div id="pdfContainer"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Go to top">↑</button>

    <!-- PDF.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!--Device detction helper-->
    <script>
        function isMobileDevice() {
            return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobile/i.test(navigator.userAgent);
        }
    </script>

    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentPdfDoc = null;
        let currentPdfPath = null;
        let currentScale = 1.0;
        let baseScale = 1.0;

        async function openPdf(path) {
            const overlay = document.getElementById("pdfOverlay");
            const container = document.getElementById("pdfContainer");
            const contentArea = document.getElementById("pdfContentArea");
            const title = document.getElementById("pdfTitle");
            document.getElementById("pdfContentArea").addEventListener("scroll", updateCurrentPage, { passive: true });
            document.getElementById("backToTopBtn").style.display = "none";

            currentPdfPath = path;
            currentScale = 1.0;

            // Show overlay
            overlay.style.display = "flex";
            container.innerHTML = '';
            contentArea.querySelector('.pdf-loading').style.display = 'block';

            // Extract filename for title
            const filename = path.split('/').pop();
            title.textContent = filename;

            try {
                // Load PDF
                const loadingTask = pdfjsLib.getDocument(path);
                const pdf = await loadingTask.promise;
                currentPdfDoc = pdf;

                // Update page info
                document.getElementById('pageInfo').textContent = `1 / ${pdf.numPages}`;

                // Hide loading indicator
                contentArea.querySelector('.pdf-loading').style.display = 'none';

                // Calculate base scale
                const containerWidth = document.getElementById("pdfContentArea").clientWidth - 20;
                const firstPage = await pdf.getPage(1);
                const viewport = firstPage.getViewport({ scale: 1 });
                baseScale = containerWidth / viewport.width * 0.95;

                // Render all pages
                await renderAllPages();

                updateZoomDisplay();
            } catch (error) {
                console.error('Error loading PDF:', error);
                container.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Error loading PDF. Please try again.</div>';
                contentArea.querySelector('.pdf-loading').style.display = 'none';
            }
        }

        async function renderAllPages() {
            const container = document.getElementById("pdfContainer");
            container.innerHTML = '';

            for (let pageNum = 1; pageNum <= currentPdfDoc.numPages; pageNum++) {
                await renderPage(currentPdfDoc, pageNum, container);
            }
        }

        async function renderPage(pdf, pageNum, container) {
            try {
                const page = await pdf.getPage(pageNum);

                // Calculate scale
                const scale = baseScale * currentScale;
                const scaledViewport = page.getViewport({ scale: scale });

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                const context = canvas.getContext('2d');
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                // Render page
                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport
                };

                await page.render(renderContext).promise;
                container.appendChild(canvas);
            } catch (error) {
                console.error(`Error rendering page ${pageNum}:`, error);
            }
        }

        function zoomIn() {
            if (currentScale < 3.0) {
                currentScale += 0.25;
                renderAllPages();
                updateZoomDisplay();
            }
        }

        function zoomOut() {
            if (currentScale > 0.5) {
                currentScale -= 0.25;
                renderAllPages();
                updateZoomDisplay();
            }
        }

        function updateZoomDisplay() {
            const percentage = Math.round(currentScale * 100);
            document.getElementById('zoomLevel').textContent = `${percentage}%`;
        }

        /*function printPdf() {
            if (currentPdfPath) {
                // Create hidden iframe for printing
                const printFrame = document.createElement('iframe');
                printFrame.style.display = 'none';
                printFrame.src = currentPdfPath;
                document.body.appendChild(printFrame);

                printFrame.onload = function () {
                    try {
                        printFrame.contentWindow.print();
                    } catch (e) {
                        // Fallback: open in new window
                        window.open(currentPdfPath, '_blank');
                    }
                    // Remove iframe after printing
                    setTimeout(() => {
                        document.body.removeChild(printFrame);
                    }, 1000);
                };
            }
        }*/

        function printPdf() {
            if (!currentPdfPath) return;

            if (isMobileDevice()) {
                // Mobile → open PDF in new tab
                window.open(currentPdfPath, "_blank");
            } else {
                // PC → use original iframe print
                const printFrame = document.createElement('iframe');
                printFrame.style.display = 'none';
                printFrame.src = currentPdfPath;
                document.body.appendChild(printFrame);

                printFrame.onload = function () {
                    try {
                        printFrame.contentWindow.print();
                    } catch (e) {
                        window.open(currentPdfPath, '_blank');
                    }

                    setTimeout(() => {
                        document.body.removeChild(printFrame);
                    }, 1000);
                };
            }
        }

        function downloadPdf() {
            if (currentPdfPath) {
                const link = document.createElement('a');
                link.href = currentPdfPath;
                link.download = currentPdfPath.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function updateCurrentPage() {
            const container = document.getElementById("pdfContentArea");
            const containerTop = container.scrollTop;
            const viewHeight = container.clientHeight;
            const canvases = Array.from(container.querySelectorAll("canvas"));

            let currentPage = 1;

            for (let i = 0; i < canvases.length; i++) {
                const pageTop = canvases[i].offsetTop;
                const pageHeight = canvases[i].offsetHeight;

                // Check if middle of page is in view
                if (
                    pageTop <= containerTop + viewHeight / 2 &&
                    pageTop + pageHeight >= containerTop + viewHeight / 2
                ) {
                    currentPage = i + 1;
                    break;
                }
            }

            document.getElementById("pageInfo").textContent =
                `${currentPage} / ${currentPdfDoc.numPages}`;
        }


        function closePdf() {
            document.getElementById("pdfOverlay").style.display = "none";
            document.getElementById("pdfContainer").innerHTML = "";
            document.getElementById("backToTopBtn").style.pointerEvents = "auto";
            currentPdfDoc = null;
            currentPdfPath = null;
            currentScale = 1.0;

            document.getElementById("backToTopBtn").style.display = "block";
        }

        // Close on overlay click (outside popup)
        document.getElementById("pdfOverlay").addEventListener('click', function (e) {
            if (e.target === this) {
                closePdf();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (document.getElementById("pdfOverlay").style.display === 'flex') {
                if (e.key === 'Escape') {
                    closePdf();
                } else if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    zoomIn();
                } else if (e.key === '-') {
                    e.preventDefault();
                    zoomOut();
                }
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="include.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: false
            });

            const albumTabs = document.querySelectorAll('#albumTabs a[data-bs-toggle="pill"]');
            albumTabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function () {
                    setTimeout(() => {
                        AOS.refresh();
                    }, 300);
                });
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const backToTopBtn = document.getElementById("backToTopBtn");

            // Make the button always visible
            backToTopBtn.style.display = "block";
            backToTopBtn.style.opacity = "1";

            // Smooth scroll to top when clicked
            backToTopBtn.addEventListener("click", function () {
                window.scrollTo({
                    top: 0,
                    behavior: "smooth"
                });
            });
        });
    </script>
</body>

</html>